# æ‰‹åŠ¨Trackä¸€æ¬¡go-ethereumçš„â€œå°â€bug

å“ˆå“ˆï¼Œåˆšåˆšå¥½å¼€å¹´ã€‚æ–°å¹´çš„ç¬¬7å¤©ï¼Œå°±è§£å†³äº†ä¸€ä¸ªå¯¹æˆ‘ä¸ªäººæ¥è¯´æ„ä¹‰æ¯”è¾ƒâ€œå°â€çš„Bugã€‚æœ‰è¶£çš„æ˜¯è¿˜ç»™ [ä»¥å¤ªåŠ](https://github.com/ethereum/go-ethereum) æäº¤äº†ä¸€ä¸ªPRï¼Œæ—¢ç„¶åœ¨8ä¸ªå°æ—¶å†…è¢«***Merge***ã€‚è¯´å®è¯ï¼Œæœ‰äº›å°æ¿€åŠ¨ï¼Œè™½ç„¶åªåŠ äº†ä¸¤è¡Œä»£ç ï¼Œä½†æ˜¯æ‰¾åˆ°ä»–å¯ä¸å®¹æ˜“ã€‚åºŸè¯ä¸å¤šè¯´å¼€å¯storyã€‚

## åˆç°ç«¯å€ª

çº¿ä¸Šéƒ¨ç½²çš„ä¸€ä¸ªä»¥å¤ªåŠèŠ‚ç‚¹ï¼ˆGethï¼‰æˆ‘ä»¬ç§°ä¸ºâ€œå¹²æ­»â€ï¼ˆæ‰‹åŠ¨æ»‘ç¨½ï¼‰ï¼Œå·®ç‚¹â€œå¹²æ­»â€ä¸€å°48Cï¼Œ128Gçš„æœºå™¨ã€‚è™½ç„¶è¯´åŒºå—é“¾èŠ‚ç‚¹æœ¬èº«æŒ–çŸ¿å°±ä¼šæ¶ˆè€—å¤§é‡çš„CPUèµ„æºï¼Œä½†æ˜¯è¯¥èŠ‚ç‚¹å¹¶æœªæŒ–çŸ¿ä»…ä»…åŒæ­¥Blockï¼Œä¸ºå•¥æ¶ˆè€—äº†100%ï¼ˆç”šè‡³æ›´å¤šï¼‰çš„CPUèµ„æºï¼Œå¹¶ä¸”è¿˜åœ¨æŒç»­å¢é•¿ã€‚äºæ˜¯ï¼Œä¸€ç›´ä½œä¸º**å’¸é±¼**çš„æˆ‘è¢«â€œæâ€å‡ºæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

## ä¸Šçº¿ç›²äººæ‘¸è±¡

Golangå¤§æ³•å¥½ï¼Œpporfå®‰æ’ä¸Šï¼Œç«ç„°å›¾ä¸‹â€œç¥é¬¼ç°èº«â€ã€‚ä¸€ä¸ªåä¸ºruntime.timerprocçš„goroutineåƒæ‰äº†90%çš„è®¡ç®—èµ„æºã€‚å®šä½å®Œæ¯•ï¼Œgolang runtimeæœ‰bugï¼Œå…¨å‰§ç»ˆã€‚ã€‚ã€‚

![å›¾ç‰‡alt](https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1578477279891&di=f552a5dcf524a262092989db8b8e5f8b&imgtype=jpg&src=http%3A%2F%2Fimg4.imgtn.bdimg.com%2Fit%2Fu%3D1218938014%2C1025602925%26fm%3D214%26gp%3D0.jpg)

å“ˆå“ˆï¼Œå½“ç„¶ä¸æ˜¯ã€‚æ¯•ç«Ÿgolangä½œä¸ºä¸€ä¸ªæ‹¥æœ‰67k starçš„å¼€æºé¡¹ç›®å†™äº†è¯¸å¦‚kubernetesï¼Œdockerç­‰é¡¹ç›®çš„è¯­è¨€ï¼Œä¸åº”è¯¥ä¼šæœ‰è¿™æ ·çš„bugï¼Œä¸åº”è¯¥è¿™ä¹ˆLowï¼Œä¹Ÿä¸ä¼šã€‚

## â€œè€å¸æœºâ€ä¸Šçº¿ï¼Œé»‘ç›’Debug

å¹¸å¥½éƒ¨é—¨å†…æ“ä½œç³»ç»Ÿå¤§ä½¬ ã€ŠAå›ã€‹ä¹Ÿæ˜¯æˆ‘çš„ç›´æ¥Leaderã€‚é€šè¿‡â€œç¥ä»™æ“ä½œâ€å¾ˆå¿«å®šä½åˆ°æˆ‘ä»¬çš„è¿›ç¨‹å¤§éƒ¨åˆ†æ—¶é—´å¤„åœ¨syscallã€‚å¹¶ä¸”é€šè¿‡gstackå’Œstraceçš„å®šä½åˆ°â€œå¹²æ­»â€è¿›ç¨‹å¤§é‡çš„è°ƒç”¨**futex**å’Œ**pselect**ã€‚

GETï¼

ä½†æ˜¯ï¼Œè¯´å®è¯ï¼Œå¹¶ä¸çŸ¥é“å¤§ä½¬è¯´çš„æ˜¯å•¥ã€‚ï¼ˆæ‰‹åŠ¨æ‚è„¸ğŸ¤¦â€â™‚ï¸ï¼‰

## ä¸‡é‡Œé•¿å¾ç¬¬ä¸€æ­¥

å†…å­˜çš„Debugç›¸å¯¹è¿˜å¥½åšï¼Œè¿™ä¸ªCPUçš„ï¼Œè¿˜çœŸæ²¡åšè¿‡ã€‚BUTï¼Œä½œä¸ºä¸€ä¸ªè€å’¸é±¼ï¼Œå½“ç„¶æ˜¯ä»â€œè½¦ç¥¸â€ç°åœºçœ‹èµ· https://github.com/golang/go/blob/367da16e91af75888e44b02932d228af7c9b0244/src/runtime/time.go#L247:6 å°±æ˜¯ä»–äº†ï¼Œä¸€ä¸ªæ°¸è¿œéƒ½ä¸ä¼šreturnçš„forå¾ªç¯ã€‚ä¸Šé¢å†™ç€æ³¨é‡Šï¼Œè¯¥å‡½æ•°æ˜¯ç”¨æ¥è¿è¡Œâ€œæ—¶é—´é©±åŠ¨â€çš„äº‹ä»¶ã€‚

```go
func timerproc(tb *timersBucket) {
	tb.gp = getg()
	for {
    		...
		now := nanotime()
		...
    		delta := int64(-1)
		for {
			...
            		// å–å‡ºå †é¡¶ç¬¬ä¸€ä¸ªtimer
			t := tb.t[0]
			delta = t.when - now
			if delta > 0 {
                	// è¿˜éœ€è¦ç»§ç»­ç­‰...
				break
			}
			ok := true
			if t.period > 0 {
                		// æ˜¯ä¸€ä¸ªticker
				t.when += t.period * (1 + -delta/t.period)
                		// è°ƒæ•´timerå †
				...
			} else {
                		// æ˜¯ä¸€ä¸ªtimer
				// ä»timerå †ä¸­ç§»é™¤ï¼Œå¹¶ä¸”è°ƒæ•´timerå †
			}
			...
            		// å‘é€å½“å‰æ—¶é—´åˆ°timeræˆ–è€…tickerçš„Cä¸­ã€‚
			f(arg, seq)
			lock(&tb.lock)
		}
		if delta < 0 || faketime > 0 {
			// timerå †ä¸­æ²¡æœ‰timerï¼Œå°†è¯¥goroutineæŒ‚èµ·ã€‚
			goparkunlock(&tb.lock, waitReasonTimerGoroutineIdle, traceEvGoBlock, 1)
			continue
		}
        	// æ¸…ç†å†…å®¹ balabala
		...
		notetsleepg(&tb.waitnote, delta) //å…³é”®æ¥äº†ï¼ˆç»§ç»­å¾€ä¸‹èµ°ï¼‰
	}
}

```

å…³é”®æ€§çš„è°ƒåº¦ä»£ç 

```go
// same as runtimeÂ·notetsleep, but called on user g (not g0)
// calls only nosplit functions between entersyscallblock/exitsyscall
func notetsleepg(n *note, ns int64) bool {
	gp := getg()
	if gp == gp.m.g0 {
		throw("notetsleepg on g0")
	}

	// å½“å‰è¿™ä¸ªgoroutineéœ€è¦è¿›å…¥syscalläº†ï¼Œ
  	// 1. é¦–å…ˆä¿å­˜å½“å‰goroutineçš„PCç­‰è¿è¡Œä¿¡æ¯
	// 2. å°†å½“å‰goroutineçš„çŠ¶æ€ä»runningæ”¹ä¸º syscall
  	// 3. æ”¾å¼ƒç»‘åœ¨å½“å‰çš„goroutineä¸Šçš„P
  	// 4. è°ƒç”¨ futex
	entersyscallblock() 
	ok := notetsleep_internal(n, ns) 
  	//  æ¢å¤ç°åœº
	exitsyscall() 
	return ok
}
```

**ç¬¦åˆå’Œå¤§ä½¬DEBUGçš„ç»“æœğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰**

åŸºæœ¬å®šä½æ˜¯ $GOROOT timeåŒ…ä¸‹ tickeræˆ–è€…timer ä½¿ç”¨è¿‡å¤šå¯¼è‡´ã€‚BUT å³ä½¿çŸ¥é“æ˜¯timeråœ¨"ææ€ª"ï¼Œä½†æ˜¯æ€»ä¸èƒ½grepæ‰€æœ‰time.NewTickerå’Œtime.NewTimerçš„æ‰€æœ‰å‡½æ•°ä¸€ç‚¹ç‚¹çœ‹å§ã€‚

## è‡ªå®šä¹‰â€œéªšæ“ä½œâ€

```bash
scott at localhost in ~/go-ethereum (masterâ—)
$ find . -name "*.go" |xargs cat|wc -l
1104086
```

è¿™ä¸ªâ€œé¬¼ä¸œè¥¿â€110ä¸‡è¡Œä»£ç ã€‚æˆ‘å“ªçŸ¥é“æ˜¯å“ªè¡Œä»£ç åœ¨é¢‘ç¹çš„NewTimerå‘¢ã€‚â€œæŠ•æœºå–å·§â€ï¼Œç›´æ¥åœ¨timeåŒ…ä¸‹ï¼Œ åœ¨NewTimerå’ŒNewTickerå¤„å¢åŠ printï¼Œå¹¶ä¸”è¾“å‡ºå½“å‰çš„è°ƒç”¨æ ˆã€‚ç¼–è¯‘è¿è¡Œã€‚å›â€œæ²™æ»©â€œ ç¿»ä¸ªé¢ç»§ç»­â€æ™’â€œè‡ªå·±ã€‚

## ç­‰**é±¼**ä¸Šé’©

â€æ™’â€œäº†ä¸¤å¤©ï¼Œ900Mçš„æ—¥å¿—å·²ç»èººåœ¨äº†æˆ‘çš„ç¡¬ç›˜é‡Œã€‚

- cat debug | grep XXXX 
- ç®€å•çš„ç»Ÿè®¡ NewTickerå’ŒNewTimerçš„æ•°é‡
- æ‰¾åˆ°æ ˆå°¾çš„è°ƒç”¨å¤„

OKï¼Œwhisperï¼Œä½ å±…ç„¶å¯åŠ¨äº†Nä¸ªgoroutineï¼Œå…‰ç®¡NewTickerä¸ç®¡Stopã€‚ æœæ–­åŠ ä¸ŠStopçš„é€»è¾‘ã€‚åå¤æµ‹è¯•2å¤©ï¼Œå‘ç°CPUæ¶ˆè€—å·²ç»æ­£å¸¸ï¼Œ3%å·¦å³ã€‚

## ç»™å®˜æ–¹æäº¤PR

ç®€å•æè¿°PRåœ¨Fixå•¥bugï¼Œ8å°æ—¶åï¼Œmergedï¼

## å°¾å£°

2019å¹´åˆï¼Œæˆ‘è¿˜æ˜¯ä¸ªgolangâ€å¼Ÿä¸­å¼Ÿâ€œï¼ˆè™½ç„¶ç°åœ¨ä¹Ÿæ˜¯ï¼ŒğŸ˜›ï¼‰ã€‚ä¸è¿‡ç»è¿‡ä¸€å¹´çš„å­¦ä¹ ï¼Œå·²ç»å¯ä»¥æœ‰æ¨¡æœ‰æ ·çš„æ’ä¸æ€ä¹ˆäº†è§£çš„é¡¹ç›®çš„é”™äº†ã€‚ 2020ï¼Œ åŠ æ²¹ï¼

golangå¤§æ³•ï¼Œè¿˜æ˜¯å¥½ï¼Œå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆã€‚
